<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WMSU Registration</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      width: 100%;
      max-width: 500px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    .header {
      background: #5a4522;
      color: white;
      text-align: center;
      padding: 14px;
      font-size: 16px;
      font-weight: bold;
    }
    .content {
      padding: 25px 20px;
      text-align: center;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 20px;
      color: #333;
    }
    input[type="email"], input[type="text"], input[type="file"], select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    .name-fields {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
    }
    .name-fields input {
      flex: 1;
    }
    .otp-boxes {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .otp-boxes input {
      width: 45px;
      height: 50px;
      text-align: center;
      font-size: 22px;
    }
    .resend-otp {
      margin: 15px 0;
      color: #5a4522;
      cursor: pointer;
      text-decoration: underline;
    }
    button {
      background: #5a4522;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 15px;
      width: 100%;
    }
    button:hover {
      background: #3a2c16;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .hidden {
      display: none;
    }
    .face-scan {
      width: 220px;
      height: 220px;
      border: 4px solid #3a86ff;
      border-radius: 50%;
      margin: 20px auto;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .id-card {
      border: 2px solid #900;
      border-radius: 8px;
      padding: 15px;
      background: #f9f9f9;
      text-align: left;
    }
    .id-header {
      background: #900;
      color: white;
      padding: 8px;
      border-radius: 6px 6px 0 0;
      font-size: 14px;
      text-align: center;
    }
    .id-photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #ccc;
      margin: 15px auto;
      overflow: hidden;
    }
    .id-photo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .success {
      font-size: 70px;
      color: green;
      margin-bottom: 10px;
    }
    .scan-instruction {
      margin: 15px 0;
      font-weight: bold;
      color: #5a4522;
      min-height: 24px;
    }
    .scan-progress {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 15px 0;
    }
    .progress-step {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: #ccc;
    }
    .progress-step.active {
      background-color: #5a4522;
    }
    .upload-container {
      position: relative;
      width: 120px;
      height: 120px;
      margin: 10px auto;
    }
    .upload-preview {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid #5a4522;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #f8f8f8;
      cursor: pointer;
    }
    .upload-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .upload-preview span {
      color: #888;
      font-size: 14px;
    }
    .upload-input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
      z-index: 10;
    }
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      max-width: 350px;
      text-align: center;
    }
    .modal-content h3 {
      margin: 0 0 10px;
      font-size: 18px;
      color: #900;
    }
    .modal-content button {
      margin-top: 15px;
      width: auto;
    }
    @media (max-width: 600px) {
      .container {
        margin: 0 10px;
      }
      .otp-boxes input {
        width: 40px;
        height: 45px;
        font-size: 20px;
      }
      .face-scan {
        width: 180px;
        height: 180px;
      }
      .name-fields {
        flex-direction: column;
        gap: 8px;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Step 1 -->
    <div id="step1">
      <div class="header">VERIFY USING YOUR WMSU GMAIL ACCOUNT</div>
      <div class="content">
        <h2>WMSU Student Verification</h2>
        <input type="email" placeholder="e.g. student@wmsu.edu.ph" id="email">
        <button onclick="validateStep1()">Next</button>
      </div>
    </div>

    <!-- Step 2 -->
    <div id="step2" class="hidden">
      <div class="header">ENTER OTP</div>
      <div class="content">
        <h2>Check your WMSU Gmail</h2>
        <div class="otp-boxes">
          <input type="text" maxlength="1" id="otp1" oninput="moveToNext(1, event)" onkeydown="handleOtpKeydown(1, event)">
          <input type="text" maxlength="1" id="otp2" oninput="moveToNext(2, event)" onkeydown="handleOtpKeydown(2, event)">
          <input type="text" maxlength="1" id="otp3" oninput="moveToNext(3, event)" onkeydown="handleOtpKeydown(3, event)">
          <input type="text" maxlength="1" id="otp4" oninput="moveToNext(4, event)" onkeydown="handleOtpKeydown(4, event)">
          <input type="text" maxlength="1" id="otp5" oninput="moveToNext(5, event)" onkeydown="handleOtpKeydown(5, event)">
          <input type="text" maxlength="1" id="otp6" oninput="moveToNext(6, event)" onkeydown="handleOtpKeydown(6, event)">
        </div>
        <div class="resend-otp" onclick="resendOTP()">Didn't receive OTP?</div>
        <button onclick="validateStep2()">Verify</button>
      </div>
    </div>

    <!-- Step 3 -->
    <div id="step3" class="hidden">
      <div class="header">FILL-UP STUDENT INFORMATION</div>
      <div class="content">
        <h2>Upload Photo & Info</h2>
        <div class="upload-container">
          <div class="upload-preview" id="uploadPreview">
            <span>Click to Upload</span>
          </div>
          <input type="file" id="photo" class="upload-input" accept="image/*" onchange="previewUploadedImage(event)">
        </div>
        <div class="name-fields">
          <input type="text" placeholder="Last Name" id="lastName">
          <input type="text" placeholder="First Name" id="firstName">
          <input type="text" placeholder="Middle Name" id="middleName">
        </div>
        <input type="text" placeholder="Student ID (numbers and hyphens only)" id="studentId" oninput="validateStudentId(this)">
        <select id="course">
          <option value="">Select Course</option>
          <option value="BSIT">BS Information Technology</option>
          <option value="BSCS">BS Computer Science</option>
          <option value="ACT">Associate in Computer Technology</option>
        </select>
        <select id="yearSection">
          <option value="">Select Year & Section</option>
          <option value="1A">1st Year - Section A</option>
          <option value="1B">1st Year - Section B</option>
          <option value="1C">1st Year - Section C</option>
          <option value="2A">2nd Year - Section A</option>
          <option value="2B">2nd Year - Section B</option>
          <option value="2C">2nd Year - Section C</option>
          <option value="3A">3rd Year - Section A</option>
          <option value="3B">3rd Year - Section B</option>
          <option value="3C">3rd Year - Section C</option>
          <option value="4A">4th Year - Section A</option>
          <option value="4B">4th Year - Section B</option>
          <option value="4C">4th Year - Section C</option>
        </select>
        <button onclick="validateStep3()">Next</button>
      </div>
    </div>

    <!-- Step 4 -->
<div id="step4" class="hidden">
    <div class="header">FACE SCAN</div>
    <div class="content">
        <h2>Facial Biometrics Detection</h2>
        <div class="scan-instruction" id="scanInstruction">Please look straight at the camera</div>
        <div class="face-scan">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display: none;"></canvas>
        </div>
        <div class="scan-progress">
            <div class="progress-step" id="step-front"></div>
            <div class="progress-step" id="step-left"></div>
            <div class="progress-step" id="step-right"></div>
        </div>
        <!-- Removed the button and added status text -->
        <div id="scanStatus" style="margin-top: 15px; font-weight: bold; color: #5a4522;">
            Processing... Please keep your face in the frame
        </div>
    </div>
</div>

    <!-- Step 5 -->
    <div id="step5" class="hidden">
      <div class="header">ID PREVIEW</div>
      <div class="content">
        <h2>ID Preview</h2>
        <div class="id-card">
          <div class="id-header">WMSU STUDENT ID</div>
          <div class="id-photo" id="idPhoto"></div>
          <p><b id="previewName"></b></p>
          <p>Student ID: <span id="previewStudentId"></span></p>
          <p>Course: <span id="previewCourse"></span></p>
          <p>Year & Section: <span id="previewYearSection"></span></p>
        </div>
        <button onclick="registerStudent()">Finish Registration</button>
      </div>
    </div>

    <!-- Step 6 -->
    <div id="step6" class="hidden">
      <div class="header">REGISTRATION COMPLETED</div>
      <div class="content">
        <div class="success">✔</div>
        <p>YOU ARE NOW REGISTERED.</p>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <h3 id="modalTitle">⚠ Warning</h3>
      <p id="modalMessage"></p>
      <button onclick="closeModal()">OK</button>
    </div>
  </div>

  <script>
    let faceEncodings = [];
    let uploadedPhoto = null;
    let videoStream = null;
    let scanState = 0; // 0: front, 1: left, 2: right
    let scanInterval = null;
    let userEmail = "";
    let faceScanState = {
        front: { captured: false, encoding: null },
        left: { captured: false, encoding: null },
        right: { captured: false, encoding: null }
    };

    function showModal(title, message) {
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalMessage").textContent = message;
        document.getElementById("modal").style.display = "flex";
    }
    
    function closeModal() {
        document.getElementById("modal").style.display = "none";
    }

    function nextStep(step) {
        for (let i = 1; i <= 6; i++) {
            document.getElementById("step" + i).classList.add("hidden");
        }
        document.getElementById("step" + step).classList.remove("hidden");

        if (step === 4) {
            startCamera();
            startFaceScan();
        }
        
        if (step === 5) {
            const firstName = document.getElementById("firstName").value;
            const lastName = document.getElementById("lastName").value;
            const middleName = document.getElementById("middleName").value;
            
            document.getElementById("previewName").textContent = `${firstName} ${middleName} ${lastName}`;
            document.getElementById("previewStudentId").textContent = document.getElementById("studentId").value;
            document.getElementById("previewCourse").textContent = document.getElementById("course").options[document.getElementById("course").selectedIndex].text;
            document.getElementById("previewYearSection").textContent = document.getElementById("yearSection").options[document.getElementById("yearSection").selectedIndex].text;
            
            // Use the uploaded photo in the ID preview
            if (uploadedPhoto) {
                document.getElementById("idPhoto").innerHTML = `<img src="${uploadedPhoto}">`;
            }
        }
    }

    function validateStep1() {
        userEmail = document.getElementById("email").value.trim();
        if (userEmail === "" || !userEmail.includes("@wmsu.edu.ph")) {
            showModal("Warning", "Please enter a valid WMSU email address.");
        } else {
            // Send OTP to email
            fetch('/api/send_otp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: userEmail })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    nextStep(2);
                    // Auto-focus first OTP box
                    setTimeout(() => document.getElementById("otp1").focus(), 100);
                } else {
                    showModal("Error", data.message);
                }
            })
            .catch(error => {
                showModal("Error", "Failed to send OTP. Please try again.");
                console.error("Error:", error);
            });
        }
    }

    function moveToNext(current, event) {
        const value = event.target.value;

        // Allow any character and move to next input if not empty
        if (value.length > 0 && current < 6) {
            document.getElementById(`otp${current + 1}`).focus();
        }
    }

    function handleOtpKeydown(current, event) {
        // Handle backspace key
        if (event.key === "Backspace") {
            const currentInput = document.getElementById(`otp${current}`);
            
            // If current input is empty, move to previous input and clear it
            if (currentInput.value === "" && current > 1) {
                const prevInput = document.getElementById(`otp${current - 1}`);
                prevInput.value = "";
                prevInput.focus();
            } else {
                // Clear current input but stay in the same box
                currentInput.value = "";
            }
            
            // Prevent default to avoid any browser-specific behavior
            event.preventDefault();
        }
    }

    function validateStep2() {
        let boxes = document.querySelectorAll(".otp-boxes input");
        let otp = "";
        
        for (let b of boxes) {
            if (b.value.trim() === "") {
                showModal("Warning", "Please fill all OTP fields.");
                return;
            }
            otp += b.value;
        }
        
        // Verify OTP with backend
        fetch('/api/verify_otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email: userEmail, otp: otp })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                nextStep(3);
            } else {
                showModal("Error", data.message);
            }
        })
        .catch(error => {
            showModal("Error", "Failed to verify OTP. Please try again.");
            console.error("Error:", error);
        });
    }

    function resendOTP() {
        fetch('/api/send_otp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email: userEmail })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModal("Success", "A new OTP has been sent to your email.");
                
                // Clear all OTP fields
                for (let i = 1; i <= 6; i++) {
                    document.getElementById(`otp${i}`).value = "";
                }
                
                // Focus back to the first OTP field
                document.getElementById("otp1").focus();
            } else {
                showModal("Error", data.message);
            }
        })
        .catch(error => {
            showModal("Error", "Failed to resend OTP. Please try again.");
            console.error("Error:", error);
        });
    }

    function validateStudentId(input) {
        // Allow only numbers and hyphens
        input.value = input.value.replace(/[^0-9-]/g, '');
    }

    function previewUploadedImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedPhoto = e.target.result;
                document.getElementById("uploadPreview").innerHTML = `<img src="${uploadedPhoto}" alt="Uploaded Photo">`;
            };
            reader.readAsDataURL(file);
        }
    }

    function validateStep3() {
        const lastName = document.getElementById("lastName").value.trim();
        const firstName = document.getElementById("firstName").value.trim();
        const studentId = document.getElementById("studentId").value.trim();
        const course = document.getElementById("course").value;
        const yearSection = document.getElementById("yearSection").value;
        
        if (!lastName || !firstName || !studentId || !course || !yearSection) {
            showModal("Warning", "Please fill out all required fields.");
            return;
        }
        
        if (!uploadedPhoto) {
            showModal("Warning", "Please upload a photo.");
            return;
        }
        
        nextStep(4);
    }

    function startCamera() {
        console.log('Starting camera...');
        let video = document.getElementById("video");
        if (videoStream) {
            console.log('Stopping existing stream');
            videoStream.getTracks().forEach(track => track.stop());
        }
        const constraints = {
            video: {
                facingMode: "user",
                width: { ideal: 640, max: 1280 },
                height: { ideal: 480, max: 720 }
            }
        };
        navigator.mediaDevices.getUserMedia(constraints)
            .then(stream => {
                console.log('Camera stream acquired');
                video.srcObject = stream;
                videoStream = stream;
                video.onloadedmetadata = () => {
                    console.log(`Video resolution: ${video.videoWidth}x${video.videoHeight}`);
                    video.play().catch(err => {
                        console.error('Video play error:', err);
                        showModal("Error", "Failed to start video. Ensure camera is enabled and try again.");
                    });
                };
            })
            .catch(err => {
                console.error('Camera error:', err);
                let message = "Camera access denied. Please allow camera access in your browser settings and refresh the page.";
                if (err.name === "NotFoundError") {
                    message = "No camera found. Please ensure your device has a working camera.";
                } else if (err.name === "SecurityError") {
                    message = "Camera access requires HTTP. Please access the site via http://192.168.254.110:5000.";
                }
                showModal("Error", message);
            });
    }

    function startFaceScan() {
        scanState = 0;
        faceEncodings = [];
        faceScanState = {
            front: { captured: false, encoding: null },
            left: { captured: false, encoding: null },
            right: { captured: false, encoding: null }
        };
        updateScanProgress();
        
        // Start automatic scanning process
        scanInterval = setInterval(automatedFaceScan, 1000); // Check every second
    }

    function automatedFaceScan() {
        const instructions = [
            "Please look straight at the camera",
            "Please turn your head slightly to the left",
            "Please turn your head slightly to the right"
        ];
        
        const instructionEl = document.getElementById("scanInstruction");
        instructionEl.textContent = instructions[scanState];
        
        // Check if we've already captured this angle
        const angleKey = ['front', 'left', 'right'][scanState];
        if (faceScanState[angleKey].captured) {
            // Move to next angle
            scanState++;
            updateScanProgress();
            
            if (scanState > 2) {
                // All angles captured, process the scan
                finishFaceScan();
                return;
            }
            return;
        }
        
        // Try to capture the current angle
        captureFaceEncoding().then(encoding => {
            if (encoding) {
                faceScanState[angleKey] = {
                    captured: true,
                    encoding: Array.from(encoding)
                };
                
                console.log(`Captured ${angleKey} face encoding`);
                updateScanProgress();
                
                // Wait a moment before moving to next angle
                setTimeout(() => {
                    scanState++;
                    updateScanProgress();
                    
                    if (scanState > 2) {
                        // All angles captured, process the scan
                        finishFaceScan();
                    }
                }, 1000);
            } else {
                console.log(`No face detected for ${angleKey}, retrying...`);
                instructionEl.textContent = `${instructions[scanState]} (No face detected, please ensure your face is centered and well-lit)`;
            }
        });
    }

    function finishFaceScan() {
        clearInterval(scanInterval);
        
        // Combine all encodings
        const allEncodings = [];
        if (faceScanState.front.encoding) allEncodings.push(faceScanState.front.encoding);
        if (faceScanState.left.encoding) allEncodings.push(faceScanState.left.encoding);
        if (faceScanState.right.encoding) allEncodings.push(faceScanState.right.encoding);
        
        if (allEncodings.length === 0) {
            document.getElementById("scanInstruction").textContent = "Face scan failed. Please try again.";
            // Restart the scan after a delay
            setTimeout(startFaceScan, 3000);
            return;
        }
        
        const avgEncoding = averageFaceEncodings(allEncodings);
        window.faceEncoding = avgEncoding;
        
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        
        document.getElementById("scanInstruction").textContent = "Face scan completed!";
        
        // Automatically proceed to next step after a brief delay
        setTimeout(() => nextStep(5), 1500);
    }

    async function captureFaceEncoding() {
        try {
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            
            // Set canvas dimensions to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                console.error("Video dimensions are zero. Camera may not be initialized.");
                return null;
            }
            
            // Draw current video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to blob for sending to server
            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.8));
            
            // Create FormData and send to server
            const formData = new FormData();
            formData.append('image', blob, 'face.jpg');
            
            const response = await fetch('/api/encode_face', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if (data.success && data.encoding) {
                return new Float32Array(data.encoding);
            } else {
                console.error("Face encoding failed:", data.message);
            }
        } catch (error) {
            console.error("Error capturing face encoding:", error);
        }
        return null;
    }
    
    function updateScanProgress() {
        // Reset all progress steps
        document.getElementById("step-front").classList.remove("active");
        document.getElementById("step-left").classList.remove("active");
        document.getElementById("step-right").classList.remove("active");
        
        // Activate steps based on current state
        if (scanState >= 0) document.getElementById("step-front").classList.add("active");
        if (scanState >= 1) document.getElementById("step-left").classList.add("active");
        if (scanState >= 2) document.getElementById("step-right").classList.add("active");
        
        // Add checkmarks for completed steps
        document.getElementById("step-front").textContent = faceScanState.front.captured ? "✓" : "";
        document.getElementById("step-left").textContent = faceScanState.left.captured ? "✓" : "";
        document.getElementById("step-right").textContent = faceScanState.right.captured ? "✓" : "";
    }

    function averageFaceEncodings(encodings) {
        const result = new Array(encodings[0].length).fill(0);
        
        for (let i = 0; i < encodings.length; i++) {
            for (let j = 0; j < encodings[i].length; j++) {
                result[j] += encodings[i][j];
            }
        }
        
        for (let j = 0; j < result.length; j++) {
            result[j] /= encodings.length;
        }
        
        return result;
    }

    function registerStudent() {
        const formData = new FormData();
        formData.append('email', userEmail);
        formData.append('student_id', document.getElementById("studentId").value);
        formData.append('first_name', document.getElementById("firstName").value);
        formData.append('last_name', document.getElementById("lastName").value);
        formData.append('middle_name', document.getElementById("middleName").value);
        formData.append('course', document.getElementById("course").value);
        formData.append('year_section', document.getElementById("yearSection").value);
        formData.append('face_encoding', JSON.stringify(window.faceEncoding));
        
        // Add photo file if uploaded
        const photoInput = document.getElementById("photo");
        if (photoInput.files.length > 0) {
            formData.append('photo', photoInput.files[0]);
        }
        
        // Show loading state
        const registerBtn = document.querySelector("#step5 button");
        registerBtn.disabled = true;
        registerBtn.textContent = "Registering...";
        
        // Send registration request
        fetch('/api/register_student', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                nextStep(6);
            } else {
                showModal("Error", data.message);
                registerBtn.disabled = false;
                registerBtn.textContent = "Finish Registration";
            }
        })
        .catch(error => {
            showModal("Error", "Registration failed. Please try again.");
            console.error("Registration error:", error);
            registerBtn.disabled = false;
            registerBtn.textContent = "Finish Registration";
        });
    }

    // Initialize OTP boxes to handle input properly
    document.addEventListener('DOMContentLoaded', function() {
        const otpInputs = document.querySelectorAll('.otp-boxes input');

        otpInputs.forEach(input => {
            input.addEventListener('keydown', function(e) {
                // Allow all characters, limit to one per box
                if (e.key === "Backspace" || e.key === "Delete") return;

                if (input.value.length >= 1 && e.key.length === 1) {
                    e.preventDefault();
                }
            });
        });
    });
</script>

</body>
</html>